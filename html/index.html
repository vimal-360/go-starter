<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Simple Workflow — Easier Connect (Bootstrap + Vue)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background:#f8fafc; }
        .card-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:16px; }
        .node-card { cursor:default; transition: box-shadow .15s, transform .12s; }
        .node-card.connect-target { box-shadow: 0 6px 20px rgba(11,87,255,0.14); transform: translateY(-4px); border: 1px solid rgba(11,87,255,0.16); }
        .node-card.connect-source { border: 2px dashed rgba(11,87,255,0.2); }
        .small-muted { font-size:0.85rem; color:#6b7280; }
        .sidebar { min-width:320px; max-width:360px; }
        pre.json { background:#0b1220; color:#e6f1ff; padding:12px; border-radius:8px; max-height:320px; overflow:auto; font-size:0.85rem; }
        .badge-target { cursor:pointer; user-select:none; }
        .connect-indicator { background:#0b57d0; color:white; padding:4px 8px; border-radius:14px; font-size:12px; }
        .hint { font-size:0.9rem; color:#475569; }
        .btn-ghost { background:transparent; border:1px solid #e6eef8; color:#0b57d0; }
    </style>
</head>
<body>
<div id="app" class="container-fluid py-4">
    <div class="d-flex align-items-center mb-3">
        <h4 class="mb-0">Simple Workflow Builder — Easier Connect</h4>
        <div class="ms-auto small-muted">Click Connect → click target card • For IfElse choose branch first</div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card p-3 mb-3">
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm" @click="addNode('Action')">+ Action</button>
                    <button class="btn btn-outline-primary btn-sm" @click="addNode('IfElse')">+ If/Else</button>
                    <button class="btn btn-outline-secondary btn-sm" @click="reset">Reset</button>
                    <button class="btn btn-success btn-sm ms-auto" @click="simulate">Simulate</button>
                </div>
            </div>

            <div class="card p-3">
                <div class="card-body">
                    <div v-if="connectFrom" class="mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <div class="connect-indicator">Connecting from #{{ connectFrom }}</div>
                            <div class="hint">Click a target node card to connect. <button class="btn btn-sm btn-outline-secondary ms-auto" @click="cancelConnect">Cancel</button></div>
                        </div>
                    </div>

                    <div class="card-grid">
                        <div v-for="node in nodes" :key="node.id" class="card node-card"
                             :class="{
                     'connect-target': connectFrom && node.id !== connectFrom,
                     'connect-source': connectFrom === node.id
                   }"
                             @click="onCardClick(node)">
                            <div class="card-body">
                                <div class="d-flex align-items-start">
                                    <div style="flex:1">
                                        <h6 class="card-title mb-1" style="line-height:1">{{ node.type }} <small class="text-muted">#{{ node.id }}</small></h6>
                                        <div class="small-muted mb-2">{{ node.title || (node.type==='Action' ? 'Action node' : 'Condition node') }}</div>

                                        <div v-if="node.type === 'Action'">
                                            <div class="mb-2"><strong>implement_id:</strong></div>
                                            <input class="form-control form-control-sm mb-2" v-model="node.implement_id" placeholder="e.g. send_email_v1" />
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-outline-primary btn-sm" @click.stop="openActionModal(node)">Open action page</button>
                                                <button class="btn btn-outline-danger btn-sm" @click.stop="removeNode(node.id)">Delete</button>
                                            </div>
                                        </div>

                                        <div v-else-if="node.type === 'IfElse'">
                                            <label class="form-label small mb-1">Expression (JS, use <code>context</code>)</label>
                                            <input class="form-control form-control-sm mb-2" v-model="node.expr" placeholder="e.g. context.user.age >= 18" />
                                            <div class="small-muted">Set next nodes for <kbd>true</kbd> and <kbd>false</kbd> via Connect.</div>
                                        </div>

                                        <div class="mt-3">
                                            <label class="form-label small mb-1">Outgoing</label>
                                            <div class="d-flex gap-2 flex-wrap">
                          <span v-if="node.type === 'Action' && node.next"
                                class="badge bg-light text-dark badge-target"
                                title="Click to remove" @click.stop="unlink(node.id,'next')">{{ findNodeLabel(node.next) }}</span>

                                                <span v-if="node.type === 'IfElse' && node.next_true"
                                                      class="badge bg-light text-dark badge-target" title="Click to remove" @click.stop="unlink(node.id,'next_true')">true → {{ findNodeLabel(node.next_true) }}</span>

                                                <span v-if="node.type === 'IfElse' && node.next_false"
                                                      class="badge bg-light text-dark badge-target" title="Click to remove" @click.stop="unlink(node.id,'next_false')">false → {{ findNodeLabel(node.next_false) }}</span>

                                                <span v-if="!hasOutgoing(node)" class="text-muted small">— none —</span>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="ms-auto text-end">
                                        <div class="small-muted mb-2">restarts: <strong>{{ node.restarts || 0 }}</strong></div>
                                        <div class="small-muted">id: <code>{{ node.id }}</code></div>
                                    </div>
                                </div>

                                <div class="mt-3 d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" @click.stop="beginConnect(node)">Connect</button>
                                    <button v-if="node.type==='Action'" class="btn btn-sm btn-outline-secondary" @click.stop="openActionModal(node)">Edit</button>

                                    <!-- If the node is the current connect source, show branch selector for IfElse -->
                                    <div v-if="connectFrom === node.id && node.type === 'IfElse'" class="ms-auto d-flex gap-2">
                                        <select v-model="connectBranch" class="form-select form-select-sm" style="width:120px;">
                                            <option value="next">default</option>
                                            <option value="next_true">true</option>
                                            <option value="next_false">false</option>
                                        </select>
                                        <button class="btn btn-sm btn-primary" @click.stop="applyConnectSelection">Pick target</button>
                                    </div>
                                </div>

                            </div>
                        </div> <!-- node card -->
                    </div> <!-- grid -->
                </div>
            </div>
        </div> <!-- left col -->

        <div class="col-lg-4">
            <div class="card sidebar p-3 mb-3">
                <h6>Selected / Tools</h6>

                <div class="mb-2">
                    <label class="form-label small mb-1">Start Node</label>
                    <select class="form-select form-select-sm" v-model="startNode">
                        <option :value="null">— select start —</option>
                        <option v-for="n in nodes" :key="n.id" :value="n.id">{{ n.type }} #{{ n.id }}</option>
                    </select>
                </div>

                <div class="mb-2">
                    <button class="btn btn-outline-secondary btn-sm w-100" @click="exportJson">Copy JSON</button>
                </div>

                <div class="mb-2">
                    <label class="form-label small mb-1">Test Context (JSON)</label>
                    <textarea class="form-control form-control-sm" rows="6" v-model="testContext"></textarea>
                </div>

                <div class="mb-2">
                    <label class="form-label small mb-1">Logs</label>
                    <div style="max-height:220px; overflow:auto; background:#0b1220; color:#e6f1ff; padding:8px; border-radius:6px; font-family:monospace; font-size:0.85rem;">
                        <div v-for="(l,i) in logs" :key="i" style="margin-bottom:4px;" v-html="l"></div>
                    </div>
                    <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-sm btn-outline-secondary" @click="clearLogs">Clear</button>
                        <button class="btn btn-sm btn-outline-primary" @click="loadExample">Load Example</button>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label small mb-1">Workflow JSON</label>
                    <pre class="json">{{ workflowJson }}</pre>
                </div>
            </div>
        </div> <!-- right col -->
    </div>

    <!-- Action modal template (reused) -->
    <div class="modal fade" id="actionModal" tabindex="-1" aria-hidden="true" ref="actionModalEl">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Action — #<span>{{ modalNode?.id }}</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div v-if="modalNode">
                        <div class="mb-3">
                            <label class="form-label small">implement_id</label>
                            <input class="form-control" v-model="modalNode.implement_id" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Title / label</label>
                            <input class="form-control" v-model="modalNode.title" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Description</label>
                            <textarea class="form-control" rows="4" v-model="modalNode.meta"></textarea>
                        </div>
                        <div class="small-muted">This modal represents a dedicated page for the action (you can extend it into a full page easily).</div>
                    </div>
                    <div v-else class="text-muted">No action selected.</div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-primary" @click="saveModal">Save</button>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Vue 3 -->
<script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
<!-- Bootstrap JS (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const { createApp, ref, reactive, computed, nextTick } = Vue;

    createApp({
        setup() {
            const nodes = reactive([]);
            const idCounter = ref(1);
            function makeId() { return idCounter.value++; }

            const logs = reactive([]);
            const testContext = ref(JSON.stringify({ user:{ age:20, email:"you@example.com"}, count:0 }, null, 2));
            const startNode = ref(null);

            // connect mode
            const connectFrom = ref(null); // node id
            const connectBranch = ref('next'); // 'next' | 'next_true' | 'next_false'

            // modal references
            const modalNode = ref(null);
            let bsModal = null;

            function addNode(type) {
                const id = makeId();
                const base = { id, type, title: '', meta: '', restarts: 0, next: null };
                if (type === 'Action') {
                    base.implement_id = ''; // only implement_id for action as requested
                } else if (type === 'IfElse') {
                    base.expr = 'context.user.age >= 18';
                    base.next_true = null;
                    base.next_false = null;
                }
                nodes.push(base);
            }

            function removeNode(id) {
                const i = nodes.findIndex(n => n.id === id);
                if (i !== -1) nodes.splice(i,1);
                // clear references
                nodes.forEach(n=>{
                    if (n.next === id) n.next = null;
                    if (n.next_true === id) n.next_true = null;
                    if (n.next_false === id) n.next_false = null;
                });
                if (startNode.value === id) startNode.value = null;
            }

            function openActionModal(node) {
                modalNode.value = node;
                nextTick(()=>{
                    const el = document.getElementById('actionModal');
                    bsModal = new bootstrap.Modal(el);
                    bsModal.show();
                });
            }

            function saveModal() {
                if (bsModal) bsModal.hide();
                modalNode.value = null;
            }

            function reset() {
                nodes.splice(0,nodes.length);
                idCounter.value = 1;
                logs.splice(0, logs.length);
                startNode.value = null;
                cancelConnect();
            }

            function exportJson() {
                const j = workflowJson.value;
                navigator.clipboard?.writeText(j).then(()=> {
                    pushLog('Workflow JSON copied to clipboard.');
                }).catch(()=> pushLog('Copied failed (no permission).'));
            }

            function pushLog(msg) {
                logs.unshift(`[${new Date().toLocaleTimeString()}] ${msg}`);
                if (logs.length > 500) logs.splice(500);
            }

            function clearLogs() {
                logs.splice(0, logs.length);
            }

            const workflowJson = computed(()=> {
                return JSON.stringify({ start: startNode.value, nodes: nodes.map(n=>{
                        return JSON.parse(JSON.stringify(n));
                    }) }, null, 2);
            });

            function loadExample() {
                reset();
                addNode('Action'); // 1
                addNode('IfElse'); // 2
                addNode('Action'); // 3
                addNode('Action'); // 4
                // configure
                nodes[0].title = 'Start Action'; nodes[0].implement_id = 'init_v1';
                nodes[1].title = 'Check age'; nodes[1].expr = 'context.user.age >= 18';
                nodes[2].title = 'Adult path'; nodes[2].implement_id = 'adult_flow_v1';
                nodes[3].title = 'Minor path'; nodes[3].implement_id = 'minor_flow_v1';
                // connect
                nodes[0].next = nodes[1].id;
                nodes[1].next_true = nodes[2].id;
                nodes[1].next_false = nodes[3].id;
                startNode.value = nodes[0].id;
                pushLog('Example loaded.');
            }

            // connect UX
            function beginConnect(node) {
                connectFrom.value = node.id;
                // default branch for IfElse is next_true (common), but we leave 'next' default
                connectBranch.value = node.type === 'IfElse' ? 'next_true' : 'next';
                pushLog(`Connect mode: from #${node.id}. Now click target node.`);
            }

            function cancelConnect() {
                connectFrom.value = null;
                connectBranch.value = 'next';
            }

            // Click on a node card while in connect mode
            function onCardClick(targetNode) {
                if (!connectFrom.value) return;
                const sourceId = connectFrom.value;
                if (targetNode.id === sourceId) {
                    pushLog('Cannot connect a node to itself.');
                    return;
                }
                const sourceNode = nodes.find(n => n.id === sourceId);
                if (!sourceNode) { cancelConnect(); return; }

                // Decide field to set based on source type and chosen branch
                const branch = connectBranch.value;
                if (sourceNode.type === 'IfElse') {
                    if (branch === 'next_true') {
                        sourceNode.next_true = targetNode.id;
                    } else if (branch === 'next_false') {
                        sourceNode.next_false = targetNode.id;
                    } else {
                        // fallback to next
                        sourceNode.next = targetNode.id;
                    }
                } else {
                    sourceNode.next = targetNode.id;
                }

                pushLog(`Connected #${sourceId} → #${targetNode.id} (${branch})`);
                cancelConnect();
            }

            // For IfElse when user clicks the "Pick target" button (alternate flow)
            function applyConnectSelection() {
                // instruct user to click target card — selection already set
                pushLog(`Connect branch set to "${connectBranch.value}". Now click a target card to complete connection.`);
            }

            function unlink(nodeId, field) {
                const node = nodes.find(n => n.id === nodeId);
                if (!node) return;
                node[field] = null;
                pushLog(`Removed ${field} from #${nodeId}`);
            }

            function hasOutgoing(node) {
                if (node.type === 'Action') return !!node.next;
                if (node.type === 'IfElse') return !!node.next_true || !!node.next_false || !!node.next;
                return !!node.next;
            }

            function findNodeLabel(id) {
                const n = nodes.find(x=>x.id === id);
                return n ? `${n.type} #${n.id}` : `#${id}`;
            }

            // very small simulator: follows next / next_true/next_false links
            async function simulate() {
                clearLogs();
                pushLog('Simulation started.');
                let context;
                try {
                    context = JSON.parse(testContext.value || '{}');
                } catch (e) {
                    pushLog('Invalid test context JSON: ' + e.message);
                    return;
                }

                if (!startNode.value) {
                    pushLog('No start node set. Choose start node in the right panel.');
                    return;
                }

                const nodeMap = {};
                nodes.forEach(n=> nodeMap[n.id] = n);
                let current = startNode.value;
                const visited = new Set();
                let steps = 0;
                const MAX_STEPS = 1000;

                while (current != null && steps < MAX_STEPS) {
                    steps++;
                    if (!nodeMap[current]) { pushLog('Node not found: ' + current); break; }
                    const node = nodeMap[current];
                    pushLog(`Visiting node #${node.id} (${node.type})`);
                    if (node.type === 'Action') {
                        // "execute" action -> here we just log implement_id; in real use you'd call backend by implement_id
                        pushLog(` → Action implement_id: ${node.implement_id || '(empty)'}`);
                        current = node.next ?? null;
                    } else if (node.type === 'IfElse') {
                        let val = false;
                        try {
                            // Evaluate expression — quick-and-dirty
                            const fn = new Function('context', 'return (' + (node.expr || 'false') + ');');
                            val = !!fn(context);
                        } catch (e) {
                            pushLog(' → IfElse eval error: ' + e.message);
                        }
                        pushLog(` → IfElse result: ${val}`);
                        current = val ? (node.next_true ?? null) : (node.next_false ?? null);
                        // fallback to node.next if the branch is not set
                        if (current == null) current = node.next ?? null;
                    } else {
                        current = node.next ?? null;
                    }

                    // simple cycle guard
                    if (visited.has(node.id)) {
                        pushLog('Cycle detected (node visited twice). Stopping.');
                        break;
                    }
                    visited.add(node.id);
                }

                if (steps >= MAX_STEPS) pushLog('Max steps reached. Stopping.');
                pushLog('Simulation finished.');
            }

            return {
                nodes, addNode, removeNode, openActionModal, modalNode, saveModal, reset,
                startNode, testContext, workflowJson, exportJson, logs, clearLogs, loadExample, simulate,
                // connect UX
                beginConnect, cancelConnect, connectFrom, connectBranch, onCardClick, applyConnectSelection,
                unlink, hasOutgoing, findNodeLabel
            };
        }
    }).mount('#app');
</script>
</body>
</html>
